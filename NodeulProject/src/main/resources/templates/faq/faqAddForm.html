<!DOCTYPE HTML>
<html th:replace="~{/layout/defaultLayout :: layout(~{::menuTitle}, ~{::sidebar}, ~{::mainSection})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
<body>

<menuTitle>알림마당</menuTitle>
<sidebar class="list-group-item sidebar-link"><a th:href="@{/sheet/list?ageGroup=유아용}" style="all: unset;">연령별</a>
</sidebar>
<sidebar class="list-group-item sidebar-link"><a th:href="@{/sheet/list?genre=그림책}" style="all: unset;">장르별</a>
</sidebar>
<sidebar class="list-group-item sidebar-link"><a th:href="@{/sheet/list?genre=독서토론논제은행}" style="all: unset;">논제은행</a>
</sidebar>
<sidebar class="list-group-item sidebar-link"><a th:href="@{/sheet/request}" style="all: unset;">개별출제요청</a></sidebar>

<mainSection>
    <div id="wrap">
        <div class="row g-0 align-items-center">
            <div class="col-auto">
                <h1 class="fs-5 fs-xl-5 mb-5">자주묻는질문 등록</h1>
            </div>
        </div>
        <form th:object="${faqRegisterDto}">
            <div class="mb-3">
                <label class="form-label" for="faqQuestion">자주묻는 질문</label>
                <span class="errorDiv" error="faqQuestion" style="color: red"></span>
                <!--                <span class="errorMsg" th:errors="*{faqQuestion}">질문 오류</span><br>-->
                <textarea name="faqQuestion" id="faqQuestion" th:field="*{faqQuestion}" class="form-control"
                          rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label" for="faqAnswer">답변</label>
                <span class="errorDiv" error="faqAnswer" style="color: red"></span>

                <!--                <span class="errorMsg" th:errors="*{faqAnswer}">답변 오류</span><br>-->
                <textarea name="faqAnswer" id="faqAnswer" th:field="*{faqAnswer}" class="form-control"
                          rows="3"></textarea>
            </div>
            <!--    <span class="errorMsg" th:errors="*{faqQuestion}">질문 오류</span>-->
            <!--    <br> 질문 <textarea name="faqQuestion" th:field="*{faqQuestion}"></textarea>-->
            <!--    <span class="errorMsg" th:errors="*{sheetBooktitle}">답변 오류</span>-->
            <!--    <br> 답변 <textarea name="faqAnswer"></textarea>-->
            <div>
                카테고리
                <select name="faqCategory" id="category">
                    <option th:each="category, stat : ${faqAllCategory}"
                            th:if="${stat.index >= 2}" th:value="${category}" th:text="${category}"></option>
                </select>

            </div>

            <div>
                <br> most/best 여부
                <input type="checkbox" name="faqBest" id="mostbest">
            </div>
            <hr>
            <div class="d-flex justify-content-end">
                <button class="btn btn-primary" type="submit" id="addBtn">FAQ 등록</button>
                <button class="btn btn-primary cancelBtn" type="button">취소</button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        document.querySelector('.cancelBtn').addEventListener('click', function () {
            window.history.back();
        });
    </script>

    <script th:inline="javascript">
        document.getElementById("addBtn").addEventListener("click", sendForm);

        function sendForm(event) {
            event.preventDefault(); // 기본 동작(폼 제출) 막기
            let faqQuestion = document.getElementById("faqQuestion").value;
            let faqAnswer = document.getElementById("faqAnswer").value;
            let faqCategory = document.getElementById("category").value;
            let faqBest = document.getElementById("mostbest").checked ? 1 : 0;

            let formData = new URLSearchParams({
                faqQuestion: faqQuestion,
                faqAnswer: faqAnswer,
                faqCategory: faqCategory,
                faqBest: faqBest
            });
            fetch("/faq/add", {
                method: 'POST',
                body: formData,
                credentials: 'include',
                header: {'ajax': true}
            })
                .then((response) => {
                    console.log("response.status : " + response.status);
                    if (response.status === 200) {
                        for (let errorDiv of document.querySelectorAll(".errorDiv")) {
                            errorDiv.innerText = "";
                        }
                        // 성공적인 응답 처리
                        alert("등록이 완료되었습니다.")
                        window.location.href = "/faq/전체";
                    } else if (response.status === 201) {
                        sendForm();
                    } else if (response.status === 400) {
                        // 예외 발생 시
                        response.json().then(data => {
                            // 에러 메시지 초기화
                            for (let errorDiv of document.querySelectorAll(".errorDiv")) {
                                errorDiv.innerText = "";
                            }
                            // 응답 데이터를 파싱하여 에러 메시지 표시
                            console.log(data);
                            for (const error of data) {
                                let errorElement = null;
                                if (error.field == null) {
                                    errorElement = document.querySelector(`[error="${error.code}"]`);
                                } else {
                                    // 해당 입력 필드 아래에 에러 메시지 표시
                                    errorElement = document.querySelector(`[error="${error.field}"]`);
                                }
                                errorElement.innerText = error.defaultMessage;
                                // inputField.parentNode.appendChild(errorElement);
                            }
                        });
                    } else if (response.status === 422) {
                        response.json().then(data => {
                            // 에러 메시지 초기화
                            for (let errorDiv of document.querySelectorAll(".errorDiv")) {
                                errorDiv.innerText = "";
                            }
                            alert("등록에 실패하였습니다.");
                            window.location.reload();
                        });
                    } else {
                        // 기타 상태 코드에 대한 처리
                    }
                })
        }
    </script>
</mainSection>
</body>
</html>