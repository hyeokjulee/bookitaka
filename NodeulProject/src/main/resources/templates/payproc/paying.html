<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Paying</title>

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
</head>
<body>
    <h1>결제하기</h1>

    <table class="table" id="payingTable">
        <thead>
            <tr>
                <th scope="col"></th>
                <th scope="col">자료명</th>
                <th scope="col">금액</th>
            </tr>
        </thead>

        <tbody class="table-group-divider" id="sheets">
            <!-- 상품 목록이 동적으로 추가될 영역 -->
        </tbody>

        <tfoot>
            <tr>
                <th id="totalcnt"></th>
                <th></th>
                <th id="totalprice"></th>
            </tr>
        </tfoot>
    </table>

    <div class="text-center">
        <button onclick="requestPay()" class="btn btn-secondary">결제하기</button>
    </div>

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

    <script src="/js/paying.js"></script>

    <!-- iamport.payment.js -->
    <script
            type="text/javascript"
            src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"
    ></script>

    <script>
        var IMP = window.IMP;
        IMP.init("imp71816073");

        function requestPay() {
            IMP.request_pay(
                {
                    pg: "kcp.INIpayTest",
                    pay_method: "card",
                    merchant_uid: "57008833-33011",
                    name: "당근 10kg",
                    amount: 100,
                    buyer_email: "Iamport@chai.finance",
                    buyer_name: "포트원 기술지원팀",
                    buyer_tel: "010-1234-5678",
                    buyer_addr: "서울특별시 강남구 삼성동",
                    buyer_postcode: "123-456",
                },
                function (rsp) {
                    console.log(rsp)
                    // callback
                    //rsp.imp_uid 값으로 결제 단건조회 API를 호출하여 결제결과를 판단합니다.
                    if (rsp.success) {
                        console.log("결제 검증 시작")
                        /** 결제 검증 **/
                        $.ajax({
                            type: 'POST',
                            url: '/verifyIamport/' + rsp.imp_uid
                        }).done(function (result) {
                            console.log(result)
                            // rsp.paid_amount와 result.response.amount(서버 검증) 비교 후 로직 실행
                            if (rsp.paid_amount === result.response.amount) {
                                alert("결제가 완료되었습니다.");
                                console.log("결제 및 검증 완료")
                                // $.ajax({
                                //     type:'POST',
                                //     url:'/lecture/payment',
                                // }).done(function() {
                                //     window.location.reload();
                                // }).fail(function(error){
                                //     alert(JSON.stringify(error));
                                // })
                            } else {
                                alert("결제에 실패했습니다." + "에러코드 : " + rsp.error_code + "에러 메시지 : " + rsp.error_message);
                                console.log("검증실패")
                            }
                        })
                    } else {
                        console.log("결제 시작부터 실패")
                        alert("결제 실패욤 " + rsp.error_msg)
                    }
                }
            );
        }
    </script>
</body>
</html>