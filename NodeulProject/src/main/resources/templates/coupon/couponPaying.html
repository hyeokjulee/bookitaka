<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>BuyCoupon</title>

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
</head>
<body>
    <h1>쿠폰 구입</h1>

    <div class="text-center">기존 160,000원 -> 할인가 100,000원<br>쿠폰을 구매하면 10만원에 독후활동지 80개를 구입하실 수 있습니다.</div>

    <div class="text-center">
        <button onclick="requestPay()" class="btn btn-secondary">결제하기</button>
    </div>

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <script src="/js/couponpaying.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuidv4.min.js"></script>

    <script>
        const uuid = uuidv4();

        var IMP = window.IMP;
        IMP.init("imp71816073");

        function requestPay() {
            if (verifyBefore(uuid, sum) === false) {
                alert("사전 검증 실패");
                return;
            }

            IMP.request_pay(
                {
                    pg: "kcp.INIpayTest",
                    pay_method: "card",
                    merchant_uid: uuid,

                    name: "북키타카 쿠폰",
                    amount: sum,
                    buyer_email: memberInfo[0],
                    buyer_name: memberInfo[1],
                    buyer_tel: memberInfo[2],

                    buyer_addr: "서울특별시 강남구 삼성동",
                    buyer_postcode: "123-456",
                },
                function (rsp) {
                    if (rsp.success) {
                    console.log(rsp);

                    // callback
                    //rsp.imp_uid 값으로 결제 단건조회 API를 호출하여 결제결과를 판단합니다.
                    // if(verifyAfter(rsp.imp_uid, rsp.merchant_uid, rsp.paid_amount)) {
                    //     alert("결제 성공 만세!!");
                    // }
                        console.log("사후 검증 시작");
                        const payMakeDto = {
                            paymentUuid: rsp.merchant_uid,

                            paymentInfo: "북키타카 쿠폰",

                            paymentPrice: rsp.paid_amount,
                            receiptUrl: rsp.receipt_url,
                            payMethod: rsp.pay_method,
                            impId: rsp.imp_uid
                        };

                        fetchCouponPaid(payMakeDto);

                    } else {
                        console.log("결제 진행 실패");
                        alert("결제 진행 실패");
                    }
                }
            );
        }

        function verifyBefore(merchant_uid, amount) {
            console.log("사전 검증 시작");
            const veriBeforeDto = { merchant_uid, amount };

            return fetchVerifyBefore(veriBeforeDto);

        }

        function fetchCouponPaid(payMakeDto) {
            fetch('/payproc/couponPaid', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payMakeDto),
                headers: {'ajax':true}
            })
            .then(response => {
                if (response.status == 200) {
                    console.log("사후 검증 완료");
                    console.log(response);

                    window.location.href = "/coupon/couponPayComplete";
                } else if (response.status === 201) {
                    console.log('사후 검증 단계에서 201');
                    fetchCouponPaid(payMakeDto);
                } else {
                    console.log('사후 검증 단계에서 오류 발생.');
                    return;
                }
            })
            .catch(error => {
                // 요청 실패 시 오류 처리
                console.error('사후 검증 요청 실패:', error);
                return false;
            });
        }

        function fetchVerifyBefore(veriBeforeDto) {
            fetch('/payproc/verifyBefore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(veriBeforeDto),
                headers: {'ajax':true}
            })
            .then(response => {
                if (response.status == 200) {
                    console.log("사전 검증 완료");
                    console.log(response);
                    return true;
                } else if (response.status === 201) {
                    console.log('사전 검증 단계에서 201');
                    fetchVerifyBefore(veriBeforeDto);
                } else {
                    console.log('사전 검증 단계에서 오류 발생.');
                    return false;
                }
            })
            .catch(error => {
                // 요청 실패 시 오류 처리
                console.error('사전 검증 요청 실패:', error);
                return false;
            });
        }
    </script>
</body>
</html>