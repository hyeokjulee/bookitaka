<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>비밀번호 수정</title>
</head>
<body>
<h1>비밀번호 수정</h1>
<form>
    <div>
        <label>현재 비밀번호:</label>
        <input type="password" name="oldMemberPassword" id="oldMemberPassword"/>
        <a class="toggle">보이기</a>
        <div class="errorDiv" error="oldMemberPassword" style="color: red"></div>
    </div>
    <div>
        <label>새로운 비밀번호:</label>
        <input type="password" name="newMemberPassword" id="newMemberPassword"/>
        <a class="toggle">보이기</a>
        <div class="errorDiv" error="newMemberPassword" style="color: red"></div>
    </div>
    <div>
        <label>비밀번호(확인):</label>
        <input type="password" name="newMemberPasswordCheck" id="newMemberPasswordCheck"/>
        <a class="toggle">보이기</a>
        <div class="errorDiv" error="newMemberPasswordCheck" style="color: red"></div>
        <div class="errorDiv" error="PasswordMatch" style="color: red"></div>
    </div>
    <div>
        <input type="submit" value="비밀번호 수정" id="editBtn"/>
    </div>
</form>
<script>
    let toggleLinks = document.getElementsByClassName('toggle');
    for (var i = 0; i < toggleLinks.length; i++) {
        toggleLinks[i].addEventListener('mouseenter', togglePasswordVisibility);
        toggleLinks[i].addEventListener('mouseleave', togglePasswordVisibility);
    }

    function togglePasswordVisibility(event) {
        let targetLink = event.target; // 커서가 위치한 링크
        let passwordInput = targetLink.previousElementSibling; // 이전 형제 요소인 입력란

        if (event.type === 'mouseenter') {
            passwordInput.type = 'text';
        } else if (event.type === 'mouseleave') {
            passwordInput.type = 'password';
        }
    }
</script>

<script th:inline="javascript">
    document.getElementById("editBtn").addEventListener("click", function(event) {
        event.preventDefault(); // 기본 동작(폼 제출) 막기
        let oldMemberPassword = document.getElementById("oldMemberPassword").value;
        let newMemberPassword = document.getElementById("newMemberPassword").value;
        let newMemberPasswordCheck = document.getElementById("newMemberPasswordCheck").value;

        let formData = new URLSearchParams({
            oldMemberPassword: oldMemberPassword,
            newMemberPassword: newMemberPassword,
            newMemberPasswordCheck: newMemberPasswordCheck,
        });
        fetch("/member/changePw", {
            method: 'PUT',
            body: formData,
            credentials: 'include',
            redirect: "manual"
        })
            .then((response) => {
                console.log("response.status : " + response.status);
                if (response.ok) {
                    for (let errorDiv of document.querySelectorAll(".errorDiv")){
                        errorDiv.innerText = "";
                    }
                    // 성공적인 응답 처리
                    alert("비밀번호 변경에 성공했습니다")
                    window.location.href = "/";
                } else if (response.status === 0) {
                    location.href = response.url;
                } else if (response.status === 400) {
                    // 예외 발생 시
                    response.json().then(data => {
                        // 에러 메시지 초기화
                        for (let errorDiv of document.querySelectorAll(".errorDiv")){
                            errorDiv.innerText = "";
                        }
                        // 응답 데이터를 파싱하여 에러 메시지 표시
                        console.log(data);
                        for (const error of data) {
                            let errorElement = null;
                            if (error.field == null) {
                                errorElement = document.querySelector(`[error="${error.code}"]`);
                            } else {
                                // 해당 입력 필드 아래에 에러 메시지 표시
                                errorElement = document.querySelector(`[error="${error.field}"]`);
                            }
                            errorElement.innerText = error.defaultMessage;
                            // inputField.parentNode.appendChild(errorElement);
                        }
                    });
                }  else if (response.status === 422) {
                    response.json().then(data => {
                        // 에러 메시지 초기화
                        for (let errorDiv of document.querySelectorAll(".errorDiv")){
                            errorDiv.innerText = "";
                        }
                        // 응답 데이터를 파싱하여 에러 메시지 표시
                        // console.log(data);
                        for (const error of data) {
                            let errorElement = null;
                            if (error.field == null) {
                                errorElement = document.querySelector(`[error="${error.code}"]`);
                            } else {
                                // 해당 입력 필드 아래에 에러 메시지 표시
                                errorElement = document.querySelector(`[error="${error.field}"]`);
                            }
                            errorElement.innerText = error.defaultMessage;
                            // inputField.parentNode.appendChild(errorElement);
                        }
                    });
                } else {
                    // 기타 상태 코드에 대한 처리
                }
            })
    });
</script>
</body>
</html>
