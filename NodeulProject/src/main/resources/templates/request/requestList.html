<!DOCTYPE html>
<html th:replace="~{/layout/defaultLayout :: layout(~{::menuTitle}, ~{::sidebar}, ~{::mainSection})}" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<menuTitle>받은 출제요청</menuTitle>
<sidebar><th:block th:replace="layout/sidebar/mypage-sidebar :: mypage"></th:block></sidebar>
<mainSection>
    <div class="justify-content-start mb-3">
        <div class="text-end">
            <div>
                <div class="btn-group">
                    <a th:href="@{/sheet/request/list?requestIsdone=-1}">
                        <button th:class="${requestIsdone == -1 ? 'btn btn-primary active' : 'btn btn-primary'}" th:text="'전체'">전체</button>
                    </a>
                    <a th:href="@{/sheet/request/list?requestIsdone=0}">
                        <button th:class="${requestIsdone == 0 ? 'btn btn-primary active' : 'btn btn-primary'}" th:text="'답변안함'">답변안함</button>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div>
        <table class="table">
            <thead>
            <tr>
                <th>No.</th>
                <th>책 제목</th>
                <th>신청자</th>
                <th>희망일</th>
                <th>답변여부</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="req : ${requestList}">
                <td id="requestNo" th:text="${req.requestNo}" onclick="goDetail(this)">No.</td>
                <td th:text="${req.requestBooktitle}" onclick="goDetail(this)">책 제목</td>
                <td th:text="${req.requestName + ' / ' + req.requestEmail}" onclick="goDetail(this)">신청자</td>
                <td th:text="${#strings.replace(req.requestHopedate, '-', '.')}" onclick="goDetail(this)">희망일</td>
                <td>
                    <select class="isdoneSelect form-select-inline">
                        <option value="0" th:selected="${req.requestIsdone == 0}">답변 전</option>
                        <option value="1" th:selected="${req.requestIsdone == 1}">완료</option>
                    </select>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

<!--        <div class="pagination">-->
<!--            <ul class="pagination justify-content-center">-->
<!--                <li class="page-item" th:if="${pageInfo.hasPreviousPage}">-->
<!--                    <a class="page-link" th:href="@{/myPay(pageNum=${pageInfo.pageNum - 1}, amount=${pageInfo.amount})}">&laquo;</a>-->
<!--                </li>-->
<!--                <li class="page-item" th:each="pageNum : ${pageInfo.getPageList()}" th:class="${pageNum} == ${pageInfo.pageNum} ? 'page-disabled active' : ''">-->
<!--                    <a class="page-link" th:href="@{/myPay(pageNum=${pageNum}, amount=${pageInfo.amount})}" th:text="${pageNum}"></a>-->
<!--                </li>-->
<!--                <li class="page-item" th:if="${pageInfo.hasNextPage}">-->
<!--                    <a class="page-link" th:href="@{/myPay(pageNum=${pageInfo.pageNum + 1}, amount=${pageInfo.amount})}">&raquo;</a>-->
<!--                </li>-->
<!--            </ul>-->
<!--        </div>-->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script th:inline="javascript">
        // 답변 여부 수정
        document.addEventListener('DOMContentLoaded', sendForm);

        function sendForm() {
            let selectElements = document.querySelectorAll('.isdoneSelect'); // 모든 select 요소 선택
            selectElements.forEach(function (selectElement) {
                // var updateBtn = selectElement.nextElementSibling; // 다음 sibling 요소인 updateBtn 버튼 선택
                selectElement.addEventListener('change', function () {

                    // Update the selected value when the option changes
                    let requestNo = selectElement.closest('tr').querySelector('#requestNo').innerText;
                    let requestIsdone = this.options[this.selectedIndex].value;

                    let formData = new URLSearchParams({
                        requestNo: requestNo,
                        requestIsdone: requestIsdone
                    });
                    fetch("/sheet/request/changestatus/" + requestNo + "/" + requestIsdone, {
                        method: 'PUT',
                        body: formData
                    })
                        .then((response) => {
                            if (response.status === 200) {
                                alert('답변 상태 수정이 완료되었습니다');
                                location.reload();
                            } else if (response.status === 201) {
                                sendForm();
                            } else {
                                // 기타 상태 코드에 대한 처리
                            }
                        })
                });
            });
        }

        // 목록 클릭 시 상세보기
        function goDetail(element) {
            var requestNo = element.parentNode.querySelector('#requestNo').textContent;
            window.location.href = "detail/" + requestNo;
        }


    </script>

</mainSection>

</body>
</html>